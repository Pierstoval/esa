<div id="root"></div>
<script type="importmap">
  {
    "imports": {
      "@jsxImportSource": "https://esm.sh/react@18.2.0",
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "urlpattern-polyfill": "https://esm.sh/urlpattern-polyfill@10.0.0",
      "ld": "https://localhost/ld.js"
    }
  }
</script>
<script type="module" src="https://esm.sh/run"></script>
<script type="text/jsx">
  import { useState, useEffect } from "react";
  import { createRoot } from "react-dom/client";
  import ld from "ld";

  if (!globalThis.URLPattern) { 
    await import("urlpattern-polyfill");
  }

  function App() {
    const pattern = new URLPattern("/authors/:id", "https://localhost");
    const [books, setBooks] = useState({});

    useEffect(() => {
      let ignore = false;
      setBooks({});
      fetch('https://localhost/books')
      .then(result => result.json())
      .then(result => {
        if (!ignore) {
          setBooks(ld(result, pattern, (books) => setBooks(books)));
        }
      });
      return () => {
        ignore = true;
      };
    }, []);

    return (
      <ul>
        {books['hydra:member']?.map(b => (<li data-testid="book">{b.title} - {b.author?.name}</li>))}
      </ul>
    );
  }

  const root = createRoot(document.getElementById("root"));
  root.render(
    <App />
  );
</script>
