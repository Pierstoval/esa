<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>React App</title>
  <script type="importmap">
    {
      "imports": {
        "@jsxImportSource": "https://esm.sh/react@18.2.0",
        "react-dom/": "https://esm.sh/react-dom@18.2.0/",
        "react": "https://esm.sh/react@18.2.0",
        "@tanstack/react-query": "https://esm.sh/@tanstack/react-query?deps=react@18.2.0",
        "urlpattern-polyfill": "https://esm.sh/urlpattern-polyfill@10.0.0",
        "ld": "https://localhost/ld"
      }
    }
  </script>
  <script type="module" src="https://esm.sh/run"></script>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    import ld from "ld";
    import {useEffect} from "react"
    import {createRoot} from "react-dom/client"
    import {
      QueryClient,
      useQuery,
      QueryClientProvider,
    } from '@tanstack/react-query'

    const queryClient = new QueryClient();
    const pattern = new URLPattern("/authors/:id", "https://localhost");

    function Books() {
      const { isPending, error, data: books } = useQuery({
        queryKey: ['books'],
        queryFn: () =>
          fetch('https://localhost/books')
          .then((res) => res.json())
          .then((data) => {
            return ld(data, pattern, (d) => { 
                queryClient.setQueryData(['books'], d)
            })
          }),
      })

      if (isPending) return 'Loading...'
      if (error) return 'An error has occurred: ' + error.message
       return (
         <ul>
           {books['hydra:member'].map(b => (<li>{b.title} - {b.author?.name}</li>))}
         </ul>
       );
    }

    function App() {
      return (
        <QueryClientProvider client={queryClient}>
          <Books />
        </QueryClientProvider>
      )
    }
    createRoot(root).render(<App />)
  </script>
</body>
</html>
